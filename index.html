let userFunctions = [];

function highlightLua(code) {
  // Detect and store user-defined function names like "local function test()"
  const userFuncPattern = /local\s+function\s+([a-zA-Z_]\w*)/g;
  let match;
  while ((match = userFuncPattern.exec(code)) !== null) {
    if (!userFunctions.includes(match[1])) {
      userFunctions.push(match[1]);
    }
  }

  const keywords = ['local', 'function', 'if', 'then', 'end', 'for', 'in', 'do', 'return'];
  const coreFunctions = ['Instance', 'print', 'pairs'];

  keywords.forEach(k => {
    const regex = new RegExp(`\\b${k}\\b`, 'g');
    code = code.replace(regex, `<span class="highlight-keyword">${k}</span>`);
  });

  coreFunctions.forEach(fn => {
    const regex = new RegExp(`\\b${fn}\\b`, 'g');
    code = code.replace(regex, `<span class="highlight-core">${fn}</span>`);
  });

  userFunctions.forEach(fn => {
    const regex = new RegExp(`\\b${fn}\\b`, 'g');
    code = code.replace(regex, `<span class="highlight-func">${fn}</span>`);
  });

  return code;
}
